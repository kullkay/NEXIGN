Анализ уязвимостей Portainer
============================

В данном разделе будет приведен анализ уязвимостей обнаруженных утилитой Trivy в Docker образе
приложения Portainer.

Ресурсы
-------

Сканер Trivy:  

```
Version: 0.61.1
Vulnerability DB:
  Version: 2
  UpdatedAt: 2025-04-24 06:18:26.329527481 +0000 UTC
  NextUpdate: 2025-04-25 06:18:26.32952731 +0000 UTC
  DownloadedAt: 2025-04-24 06:27:12.018869729 +0000 UTC
```

Docker-образ: portainer/portainer-ce:2.25.0 

Процесс сканирования
--------------------

1.  Сканирование Portainer, сканером Trivy:

    ```
    sudo trivy image -f json -o portainer.json portainer/portainer-ce:2.25.0
    ```

2.  Конвертирование json формата в более удобный xlsx:

    ```
    python3 convert_json_to_xlsx.py
    ```

3.  Ручной триаж уязвимостей. Результат триажа указан в файле portainer_vulns_itog.xlsx.

Результаты триажа уязвимостей
-----------------------------

После анализа всех выданных уязвимостей можно выделить следующие:

* CVE-2025-30204 -- (CRITICAL) Уязвимость присутствует и является причиной атаки. Уязвимость заключается
  в неправильной обработке JWT токена от клиента, что может привести к DoS атаке.

  Исправление: 

  - Обновите библиотеку golang-jwt/jwt до версии 4.5.2 или новее
  - Подтянуть исправления из патчей bf316c48 и 0951d184
  - Добавить проверки на корректность расположения точек в JWT токене перед использованием
    функции parse.ParseUnverified

* CVE-2024-45341 -- (HIGH) Уязвимость присутствует в стандартной библиотеке Go (crypto/x509), и
  может привести к нарушению политики сертификатов. связанная с некорректной обработкой
  URI-ограничений в сертификатах, содержащих IPv6-адреса с zone ID. Однако в публичной инфраструктуре
  сетях использование URI в сертификатах не допускается, поэтому уязвимость затрагивает только частные сетях.

  Исправление: 

  - не использовать сертификаты с URI, имеющим адрес IPv6 с идентификатором зоны 
  - обновить до версии 1.22.12, 1.23.6, 1.24.0-rc.3

* CVE-2025-22871 -- (MEDIUM) Уязвимость присутствует в обработке  конца строк в пакете HTTP, что
  может привести к скрытым запросам. Однако довольна сложна в реализации и также необходима иметь
  непосредственный доступ к аккаунту с необходимыми правами.

  Исправление:

  - Обновить до версии 1.23.8, 1.24.2;
  - Спрятать интерфейс portainer за другим прокси, например nginx
  - Так как portainer это прокси между web-интерфейсом и API docker, то нив коем случае нельзя
    позволять прямой транслирование HTTP запросов в систему, без тщательной обработки.

* CVE-2025-24358 -- (MEDIUM) Уязвимость присутствует и является способ атакующему расширить зону
  влияния, однако не является началом атаки. Возможность проводить атаки CSRF, если нарушитель
  контролирует поддомен.

  Исправление:

  - Обновите библиотеку gorilla/csrf до версии 1.7.2 или новее;
  - Подтянуть исправления из патча 9dd6af1f;


* CVE-2024-51744 -- (LOW) Уязвимость присутствует, но не является началом атаки, возникает по
  причине не корректной работы функции ParseWithClaims, в следствие чего у клиента может
  присутствовать неправильная обработка токенов. Однако не сильно критична для функционирования
  сервиса. 

  Исправление: 

  - Обновите библиотеку golang-jwt/jwt до версии 4.5.1 или новее
    (не рекомендуется, так как она может быть не совместима);
  - Проверьте код на предмет использования ParseWithClaims и убедитесь, что все ошибки
    обрабатываются корректно, особенно при использовании errors.Is.