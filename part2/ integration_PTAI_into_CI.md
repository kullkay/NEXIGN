# Инструкция по интеграции PT AI  в CI для разработки JAVA/C++

Плагины осуществляют полный цикл взаимодействия с сервером PT AI Enterprise Edition
(далее также — PT AI Enterprise Server): авторизацию, передачу исходного кода, постановку
задачи сканирования, отслеживание прогресса ее выполнения и загрузку полученных
результатов. На этапе постановки задачи сканирования PT AI Enterprise Server добавляет ее в
очередь, а затем передает на выполнение первому освободившемуся агенту сканирования
(далее также — PT AI Enterprise Agent).

Шаги сборки запускаются в последовательности, указанной в параметрах настройки проекта
CI/CD-системы. Одним из таких шагов является вызов плагина для анализа кода. В общем
случае плагины запускаются как отдельный модуль на агенте сборки CI/CD-системы. Схема
взаимодействия PT AI Enterprise Edition с DevOps-инфраструктурой представлена на рисунке
ниже.

![Размещение PT AI Enterprise Edition в DevOps-инфраструктуре](./images/PTAI_placement.png)

DevOps.Repository -  Корпоративное хранилище с исходным кодом для сканирования;

DevOps.CI -          Корпоративная CI-система, в которой запускаются сборки;

CI.BuildAgent -      Сборочный агент CI-системы. Получает исходный код и предоставляет его для
                     использования плагинам;

BuildAgent.Console - Системная консоль сборочного агента;

CI.Plugins -         Плагины CI-системы AI.Plugin Плагин PT AI Enterprise Edition. Отправляет
                     исходный код в PT AI Enterprise Server, отслеживает прогресс и скачивает отчеты;

AI.Server -          Модуль PT AI Enterprise Server. Принимает исходный код, ставит задачу
                     сканирования модулю PT AI Enterprise Agent и сохраняет результаты;

AI.Agent -           Модуль PT AI Enterprise Agent. Принимает задачу сканирования от
                     PT AI Enterprise Server и возвращает результаты.

## Предварительные требования

Минимальные аппаратные и программные требования для компьютера с модулем
PT AI Enterprise Server:

- x86_64-совместимый 8-ядерный процессор с тактовой частотой 2,4 ГГц;
- 16 ГБ оперативной памяти;
- 200 ГБ на жестком диске;
- сетевой адаптер 10 Мбит/с;
- операционная система: Debian версий 10, 11, CentOS версии 8, Ubuntu версий 18.04 LTS,
  20.04 LTS, 21.04, 21.10, 22.04, 22.10, «РЕД ОС» версии 7.3; Astra Linux версий 1.7 и 2.12;
- дополнительное ПО: Docker CE версии 20 или выше;
- доступные порты 80, 443, 5432, 5671, 5672, 8501 для взаимодействия с PT AI Enterprise
  Agent.
  Примечание. Если между PT AI Enterprise Server и клиентом установлен прокси-сервер,
  необходимо на стороне прокси-сервера разрешить обмен данными по протоколу
  WebSocket.
  Примечание. На компьютере с модулем PT AI Enterprise Server рекомендуется выделить от
  одного до двух объемов оперативной памяти под swap-раздел.
  Минимальные аппаратные и программные требования для компьютера с модулем
  PT AI Enterprise Agent:
- x86_64-совместимый 8-ядерный процессор с тактовой частотой 2,4 ГГц;
- 16 ГБ оперативной памяти;
- 50 ГБ на жестком диске;
- сетевой адаптер 10 Мбит/с;
- операционная система: 64-разрядная версия Windows 10, 64-разрядная версия Windows
  Server 2016, Debian версий 10, 11, CentOS версии 8, Ubuntu версий 18.04 LTS, 20.04 LTS,
  21.04, 21.10, 22.04, 22.10, «РЕД ОС» версии 7.3, Astra Linux версий 1.7 и 2.12;
- дополнительное ПО: Docker CE версии 20 или выше.
  Минимальные аппаратные и программные требования для компьютера с модулем AI.Shell:
- процессор Intel Core i5 с частотой 2 ГГц или аналоги;
- 512 МБ оперативной памяти;
- сетевой адаптер 10 Мбит/с;
- операционная система: 64-разрядная версия Windows 10, 64-разрядная версия Windows
  Server 2016, Debian версий 10, 11, CentOS версии 8, Ubuntu версий 18.04 LTS, 20.04 LTS,
  21.04, 21.10.
  Аппаратные и программные требования 8
  Для работы с веб-интерфейсом рекомендуется использовать браузер:
- Mozilla Firefox 106 и выше, Microsoft Edge, Google Chrome 107 и выше, Safari 15 и выше
  (только для macOS).

## Пошаговые действия

1. Установка продукта PT AI Enterprise.
2. Настройка системных параметров в веб-интерфейсе, в том числе создание токена доступа для 
   подключения PT AI Enterprise Agent к PT AI Enterprise Server.
3. Установка PT AI Enterprise Agent и его подключение к PT AI Enterprise Server по токену
   доступа. Рекомендуется разворачивать PT AI Enterprise Agent на отдельном компьютере,
   чтобы ресурсоемкий анализ кода, выполняемый PT AI Enterprise Agent, не влиял на
   производительность PT AI Enterprise Server. PT AI Enterprise Server поддерживает работу
   нескольких модулей PT AI Enterprise Agent. Увеличение числа установленных модулей
   PT AI Enterprise Agent позволяет одновременно сканировать несколько проектов.
4. Установка AI.Shell, для интеграция с CI-системами.
5. Настройка конфигурационного файла и файла с правилом срабатывания политики
   безопасности для запуска сканирования с помощью AI.Shell.

### Установка продукта PT AI Enterprise

В общем случае установка PT AI Enterprise Edition состоит из следующих этапов:

1. Установка модуля PT AI Enterprise Server.
2. Развертывание модуля PT AI Enterprise Agent:
   • предварительная установка и настройка программ, необходимых для работы модуля;
   • установка модуля;
   • настройка модуля.
3. Установка легкого агента AI.Shell.

#### Установка модуля PT AI Enterprise Server.

Установка PT AI Enterprise Server производится на Linux.

    Внимание! Для работы PT AI Enterprise Server в операционной системе должен быть
              установлен компонент Docker CE версии 20 или выше. Docker CE, установленный из
              snapпакета не йподдерживается.

    Внимание! При установке PT AI Enterprise Server в Astra Linux необходимо использовать
              ядро generic, так как ядро с усиленной защитой (hardened) не позволяет запускать
              непривилегированные контейнеры.

Чтобы установить PT AI Enterprise Server:

1. Запустите скрипт установки:
   sudo sh applicationinspector.<Версия сборки PT AI Enterprise Server>.run
   или
   sudo sh applicationinspector.<Версия сборки PT AI Enterprise Server>.run
   -- --noconfirm, для запуска установки без необходимости подтверждения дальнейших
   операций.
2. При запуске скрипта сформируется файл журнала /var/log/ptai/install/ptaiinstall-<Дата и время>.log
   который содержит информационные сообщения от системы, предупреждения и ошибки. Примечание.
   Сервисы, запущенные в Docker-контейнере, обращаются к узлу, на котором развернут PT AI Enterprise
   Server, по его имени (hostname). Если у вас не настроен DNS-сервер для разрешения имен узлов в
   IP-адреса, вы можете установить соответствие имени узла и IP-адреса, указав параметр
   AdvertiseAddr= в файле /etc/ptai/ptai.conf, а затем перезапустить PT AI Enterprise Server
   командой ptaictl restart, чтобы изменения вступили в силу.
3. Введите y, чтобы принять условия лицензионного соглашения.
4. Введите y, чтобы подтвердить установку PT AI Enterprise Server.
   Начнется установка PT AI Enterprise Server.

   Примечание. По завершении установки вы можете проверить установленные Dockerконтейнеры командой
   docker ps -a. Для мониторинга работы Docker-контейнеров рекомендуется использовать команду docker
   stats или утилиту ctop.

PT AI Enterprise Server установлен. Дистрибутив хранится в каталоге /opt/ptai.

Для управления работой PT AI Enterprise Server из консоли используется скрипт ptaictl. С
помощью скрипта ptaictl вы можете:

- останавливать работу PT AI Enterprise Server командой sudo /opt/ptai/latest/bin/
  ptaictl stop;
- возобновлять работу PT AI Enterprise Server командой sudo /opt/ptai/latest/bin/
  ptaictl start;
- перезапускать PT AI Enterprise Server командой sudo /opt/ptai/latest/bin/ptaictl
  restart;
- удалять PT AI Enterprise Server командой sudo /opt/ptai/latest/bin/ptaictl
  uninstall;
- вызывать список всех доступных команд для PT AI Enterprise Server командой sudo /opt/
  ptai/latest/bin/ptaictl help;
- выполнять замену серверного сертификата и ключа командой sudo /opt/ptai/latest/
  bin/ptaictl cert.
  Команды stop, start, restart и reconf можно выполнять без подтверждения, используя флаг
  --noconfirm.
  Для журналирования в файл результатов выполнения команд stop, start и uninstall
  используется флаг -l или --log. Например, sudo /opt/ptai/latest/bin/ptaictl start
  -l /tmp/log.txt.
  Для команды cert используются флаги:
- -с или --cert Путь к файлу с сертификатом в формате PEM.
- -k или --key Путь к файлу с закрытым ключом в формате PEM, ключ не должен быть зашифрован.
- --norestart Не выполнять перезапуск Docker-контейнеров.

По умолчанию скрипт ptaictl запускается в тихом режиме, без вывода на экран информации
от сервисных команд (кроме данных об ошибках). Для отображения подробной информации вы
можете указать флаг VERBOSE с любым непустым значением. Например, sudo VERBOSE=1 /
opt/ptai/latest/bin/ptaictl stop.

При изменении объема оперативной памяти, выделенной для виртуальной машины,
необходимо выполнить команду ptaictl reconf и перезапустить PT AI Enterprise Server для
пересчета коэффициентов потребления оперативной памяти внутри Docker-контейнеров.
Перезапуск PT AI Enterprise Server осуществляется путем последовательного выполнения
команд ptaictl stop, ptaictl start.

##### Установка сертификатов для подключения к внешнимресурсам по SSL

Если для подключения к внешним ресурсам, таким как SSO, Jira и VCS, у вас используется SSLпротокол,
то для корректного взаимодействия этих ресурсов с PT AI Enterprise Edition необходимо загрузить
в PT AI Enterprise Server один или несколько их корневых сертификатов.

Чтобы загрузить корневые сертификаты в PT AI Enterprise Server:

1. На компьютере с установленным PT AI Enterprise Server скопируйте PEM-файлы SSLсертификатов
   центра сертификации (СА) в следующие каталоги:
   /opt/ptai/_data/volumes/certs/sso/ — для SSO;
   /opt/ptai/_data/volumes/certs/jira/ — для Jira;
   /opt/ptai/_data/volumes/certs/git/ — для VCS (Git, TFS).
2. Перезапустите PT AI Enterprise Server:
   sudo /opt/ptai/latest/bin/ptaictl restart --noimgext

После перезапуска SSL-сертификаты из PEM-файлов будут добавлены в доверенные в следующих
Docker-контейнерах

- auth — использует SSL-сертификаты для подключения к SSO;
- backend — использует SSL-сертификат для подключения к Jira;
- file-content — использует SSL-сертификаты для подключения к VCS (Git, TFS).

#### Развертывание модуля PT AI Enterprise Agent

Этот раздел содержит инструкции по подготовке к развертыванию, установке и настройке
модуля PT AI Enterprise Agent. PT AI Enterprise Agent можно установить на Windows и Linux.
(Дальше будет расмотренн вариант с Linux)

##### Установка модуля PT AI Enterprise Agent для Linux

   Внимание! Для работы PT AI Enterprise Agent в операционной системе должен быть
             установлен компонент Docker CE версии 20 или выше.

   Внимание! При установке PT AI Enterprise Agent в Astra Linux необходимо использовать ядро
             generic, так как ядро с усиленной защитой (hardened) не позволяет запускать
             непривилегированные контейнеры.

Чтобы установить PT AI Enterprise Agent:

1. Сделайте файл инсталлятора исполняемым:
   chmod +x <Версия сборки PT AI Enterprise Agent>.run
2. Запустите скрипт установки:
   sudo ./<Версия сборки PT AI Enterprise Agent>.run
   При запуске скрипта сформируется файл журнала /var/log/ptaiagent/install/
   ptai-agent-install-<Дата и время>.log, который содержит системные
   информационные сообщения, предупреждения и ошибки.
3. Введите y, чтобы принять условия лицензионного соглашения.
4. Введите y, чтобы подтвердить установку PT AI Enterprise Agent. Начнется установка
   PT AI Enterprise Agent.
5. Выберите способ настройки подключения модуля PT AI Enterprise Agent к
   PT AI Enterprise Server:
   * если вы хотите настроить подключение к PT AI Enterprise Server в процессе установки,
     введите y;
   * если вы хотите настроить подключение к PT AI Enterprise Server позднее в
     конфигурационном файле в каталоге /etc/ptai-agent.conf, введите n.
6. Если вы ввели y, укажите следующие параметры:
   * URL PT AI Enterprise Server.
   * Токен доступа (см. раздел «Настройка токенов доступа» в Руководстве пользователя).
   * Уникальное имя PT AI Enterprise Agent.

     Примечание. Указанное имя будет отображаться в веб-интерфейсе на странице
     Агенты сканирования. Имя Docker-контейнера останется прежним — ptai-agent.
   * Имя узла и IP-адрес PT AI Enterprise Server в виде <Имя узла:IP-адрес> (необязательно).

     Примечание. PT AI Enterprise Agent, запущенный в Docker-контейнере, обращается к
     узлу, на котором развернут PT AI Enterprise Server, по его имени (hostname).
     Если у вас не настроен DNS-сервер для разрешения имен узлов в IP-адреса, вы
     можете установить соответствие имени узла и IP-адреса c помощью этого параметра.

PT AI Enterprise Agent установлен. Дистрибутив хранится в каталоге /opt/ptai-agent.

##### Настройка модуля PT AI Enterprise Agent

Чтобы настроить модуль PT AI Enterprise Agent для Linux:

1. Откройте файл ptai-agent.conf в каталоге /etc.
2. Измените нужные строки в файле:
   SERVER_URL="<Адрес PT AI Enterprise Server>"
   HOSTS="<Имя узла PT AI Enterprise Server:IP-адрес PT AI Enterprise Server>"
   AGENT_TOKEN="<Токен доступа>"
   AGENT_NAME="<Уникальное имя PT AI Enterprise Agent>"
3. Перезапустите Docker-котейнер PT AI Enterprise Agent:
   sudo systemctl restart ptai-agent.
   
Модуль PT AI Enterprise Agent настроен.


#### Установка легкого агента AI.Shell

Если в компании предусмотрена интеграция в CI-процесс на агентах сборки (далее также —
CI-агентах) под управлением ОС семейства Linux или вы работаете с Docker-контейнерами,
вам необходимо установить на CI-агенты компонент AI.Shell. AI.Shell — это легкий кроссплатформенный
агент, который отправляет задачу сканирования модулю PT AI Enterprise Server, а PT AI Enterprise
Server ставит задачу в очередь на выполнение доступному PT AI Enterprise Agent.

#### **Установка легкого агента AI.Shell**

Если в компании предусмотрена интеграция в CI-процесс на агентах сборки (далее также —
CI-агентах) под управлением ОС семейства Linux или вы работаете с Docker-контейнерами,
вам необходимо установить на CI-агенты компонент AI.Shell. AI.Shell — это легкий кроссплатформенный
агент, который отправляет задачу сканирования модулю PT AI Enterprise Server, а
PT AI Enterprise Server ставит задачу в очередь на выполнение доступному PT AI Enterprise Agent.

| OC                                                      | Расширение пакета установки                                            |
| ------------------------------------------------------- | ----------------------------------------------------------------------------------------------- |
| Microsoft Windows (x64)                                 | Стандартный инсталлятор для Microsoft Windows или через docker |
| Alpine (x64) последней версии или LTS | .tar.gz                                                                                         |
| CentOS(x64) последней версии или LTS  | rpm                                                                                             |
| Ubuntu (x64) последней версии или LTS | .deb                                                                                            |
| Debian (x64) последней версии или LTS | .deb                                                                                            |
| Другие Linux-системы                       | .tar.gz                                                                                         |

Примечание! В дальнейшем будет расмотрен только варинат с Установка AI.Shell из пакетов с
            расширениями .deb и .rpm. Более подробно варианты с установко, для других систем можо
            найти на [официальном сайте][https://www.ptsecurity.com/ru-ru/products/ai/#resources]

##### Установка AI.Sh

Примечание. Если в ОС не установлена библиотека libssl, которая необходима для
            безопасной передачи данных через интернет и является частью реализации протоколов
            шифрования SSL и TLS, ее нужно предварительно установить.

Чтобы установить AI.Shell из пакетов с расширениями .deb и .rpm,
выполните команду установки:

apt-get install <Имя пакета> или dpkg -i <Имя пакета> — для .deb-пакетов;
rpm -i <Имя пакета> — для .rpm-пакетов.

##### Конфигурирование AI.Shell и запуск сканирования

Вы можете создавать проект и запускать сканирование с помощью AI.Shell из командной
строки или на CI-агенте.

Чтобы запустить задачу сканирования с помощью AI.Shell:

1.  Настройте подключение AI.Shell к модулю PT AI Enterprise Server командой:
    aisa --set-settings -u <Адрес PT AI Enterprise Server> -t <Токен доступа>
    Примечание. Если запуск сканирования производится на CI-агенте, вы можете не
    настраивать подключение к PT AI Enterprise Server отдельной командой, а указывать
    параметры подключения непосредственно при запуске сканирования: aisa -u
    <АдресPT AI Enterprise Server> -t <Токен доступа> --project-name "<Имя проекта
    сканирования>" --scan-target "<Путь к объекту сканирования>.
2.  Если вы хотите запустить сканирование проекта и одновременно настроить его
    параметры, выполните команду:
    aisa --project-settings-file "<Путь к конфигурационному файлу>" --scan-target "<Путь к
    объекту сканирования>"
3.  Если вы хотите запустить сканирование ранее созданного проекта с текущими
    параметрами, выполните команду:
    aisa --project-name "<Имя проекта сканирования>" --scan-target "<Путь к объекту
    сканирования>"




#### Установка плагина

Чтобы установить плагин AI.Cli.Plugin:
1.  Получите плагин в Positive Technologies или соберите его самостоятельно по инструкции (см. приложение А).
2.  Скопируйте плагин на узел, где он будет запущен.
3.  Установите последнюю версию Java JDK 8.
4.  Обеспечьте безопасное соединение с PT AI Enterprise Server одним из перечисленных
способов:
      * Импортируйте цепочку SSL-сертификатов удостоверяющего центра, выпустившего
        SSL-сертификат для PT AI Enterprise Server, или сам сертификат PT AI Enterprise Server
        (при использовании самоподписанного сертификата) в хранилище сертификатов Java.
        Вам потребуются сертификаты в кодировке Base64 (PEM-формат) и утилита keytool
        (входит в пакет Java JDK).

        Примечание. Если иерархия сертификатов, используемых для выпуска сертификата
                    PT AI Enterprise Server, содержит Root CA и Intermediate CA как показано на рисунке
                    ниже, необходимо экспортировать оба этих сертификата в кодировке Base64.
        Импортируйте сертификаты с использованием keytool (пример команды для ОС
        семейства Unix):
        keytool -importcert -keystore jdk1.8\jre\lib\security\cacerts -storepass "changeit" -alias
        AIRootCA -file RootCA.pem –noprompt
        keytool -importcert -keystore jdk1.8\jre\lib\security\cacerts -storepass "changeit" -alias
        AIIntermediateCA -file IntermediateCA.pem –noprompt
      * Используйте параметр плагина –truststore для указания пути к PEM-файлу с цепочкой
        сертификатов сервера. Аналогично примеру выше вам потребуется экспортировать
        сертификаты в кодировке Base64, затем в текстовом редакторе соединить их в цепочку
        в обратном порядке: Intermediate → Root и сохранить в файл. Параметр нужно
        использовать для каждой команды запуска плагина.
      * Используйте параметр плагина --insecure для работы без указания сертификата (не
        рекомендуется при развертывании в рабочей среде). При использовании этого
        параметра сохраняется возможность установки защищенного соединения с
        PT AI Enterprise Server, но не выполняется проверка принадлежности сертификата,
        предъявленного сервером в ходе установки SSL-соединения, этому серверу. Параметр
        нужно использовать для каждой команды запуска плагина.
5.  Проверьте соединение с PT AI Enterprise Server, выполнив команду:
    java -jar ptai-cli-plugin.jar check-server --url=https://<Адрес PT AI Enterprise Server>
    --token=<Ваш токен>
    Примечание. Для создания токена доступа необходимо перейти в веб-интерфейс PT AI
    Enterprise Edition и выполнить инструкцию из раздела «Создание токена доступа» в
    Руководстве пользователя.

#### Подготовка команды запуска сканирования

Чтобы подготовить команду запуска сканирования:
1.  Укажите полный путь к плагину в вызове Java:
    java -jar ptai-cli-plugin.jar
2.  Определите способ настройки сканирования одним из параметров:
    * ui-ast, если проект сканирования создан в веб-интерфейсе PT AI Enterprise   Edition;
    * json-ast, если при запуске плагина вы хотите указать конфигурационный файл и файл политики безопасности.
3.  Если вы ввели ui-ast, в параметре --project укажите имя проекта, созданного в PT AI
    Enterprise Edition.
4.  Если вы ввели json-ast, в параметрах --settings-json и --policy-json укажите путь
    к конфигурационному файлу и файлу политики безопасности (необязательно) в формате JSON.
5.  Укажите путь к каталогу с исходным кодом в параметре --input.
6.  Определите режим сканирования:
    * --async для сканирования в асинхронном режиме. В этом случае будет запущена
      проверка кода на наличие уязвимостей и сборка продолжится, не дожидаясь
      завершения проверки.
    * по умолчанию для сканирования в синхронном режиме. В этом случае будет запущена
      проверка кода на наличие уязвимостей и сборка не продолжится до тех пор, пока
      проверка не завершится.
7.  Укажите требования к отчету об уязвимостях (только для синхронного режима):
    * Для формирования одного отчета укажите параметры из таблицы ниже.
    * Для формирования нескольких отчетов укажите требования в JSON-файле и задайте
      путь к нему в параметре --report-json. Синтаксис файла приведен в приложении.
8.  Укажите параметры подключения к PT AI Enterprise Server:
    --url — адрес PT AI Enterprise Server.
    --token — токен доступа для плагинов CI/CD.
    Примечание. Для создания токена доступа необходимо перейти в веб-интерфейс PT AI
    Enterprise Edition и выполнить инструкцию из раздела «Создание токена доступа» в
    Руководстве пользователя.
9.  Укажите условия неуспешного сканирования (только для синхронного режима):
    * Добавьте параметр --fail-if-failed, чтобы плагин завершал работу с ошибкой при
      несоответствии сканируемого приложения заданной политике безопасности.
    * Добавьте параметр --fail-if-unstable, чтобы плагин завершал работу с ошибкой при
      возникновении ошибок, не связанных с результатами проверки кода на наличие
      уязвимостей (например, ошибки в конфигурации, отсутствующая или недействительная
      лицензия).

10. Укажите каталог для сохранения отчетов по результатам сканирования в параметре --
    output (по умолчанию используется каталог .ptai).\
    Примечание. Во всех режимах работы плагин создает файл rest.url со ссылкой на
                результаты сканирования в формате JSON. Для открытия этой ссылки необходимо
                использовать токен доступа, который можно получить через API.
11. С помощью параметров --includes и --excludes добавьте или исключите
    определенные файлы из сканирования по маске. Используется синтаксис Apache Ant.
12. Добавьте параметр --verbose для включения расширенного протоколирования
    действий плагина.
13. Выполните получившуюся команду.
    Если все параметры указаны корректно, отобразится уведомление о постановке
    сканирования в очередь, как показано на рисунке ниже.

    ![][images/start_plagin.png]